## 使用API Gateway

在这本共七个章节关于设计，构建与部署微服务的书中，第一章节介绍了微服务架构模式，讨论了使用微服务的好处和缺点以及如何使用微服务，除去复杂性，微服务是复杂应用的理想选择。这是本书的第二章节，将讨论使用API Gateway构建微服务。

当你选择将应用构建成一组微服务，你需要决定应用的客户端如何与微服务进行沟通。巨石应用只有一组端点，通常是一样的，通过使用负载均衡在它们之间分发流量。

然而，在微服务架构中，每一个微服务通常会暴露一组细粒度的端点。在本篇中，我们将评估这一切将如何影响客户端与应用之间的通信，提议使用API Gateway作为一个解决方案。

### 介绍

让我们想象下你正在为一个购物应用开发一个原生移动客户端。您可能需要实现产品详细信息页面，展示特定产品的信息。

比如，图2-1展示了在Amazon安卓移动客户端中滚动浏览商品详情而看到的页面

![2-1](2-1.png)
图2-1 购物应用示例

尽管这是个只能手机的应用，商品详情页却展示了很多信息。比如，不仅仅只有名称，概况与价格的基本产品信息，该页面还展示了：

1. 购物车中商品的总量
2. 订单历史
3. 用户浏览
4. 低库存告警
5. 运输选项
6. 各种推荐，包括与该商品一起被购买的商品，购买该商品的用户购买的其它产品，还有购买此商品的用户浏览的其它商品
7. 替代性的购买选项

当使用巨石应用架构，移动客户端通过对应用进行一个单一的REST调用以检索数据，比如：
GET api.company.com/productdetails/productId

负载均衡将此访问路由到多个完全一样应用实例中的一个。该应用然后查询多个数据库表，在将结果返回给客户端。

与此相反的是，当使用微服务架构，商品详情页中所展示的数据是被多个微服务而拥有。以下是一些潜在拥有示例特定商品页面中数据的微服务：

- 购物车服务-购物车中的商品总数
- 订单服务-订单历史
- 目录服务-商品基本信息，比如商品名，图片与价格
- 足迹服务-用户足迹
- 库存服务-低库存告警
- 运输服务-运输选项，截止日期与费用，drawn separately from the shipping provider’s API与运输服务供应商的API独立
- 推荐服务-建议的商品
  
![2-2](2-2.png)
图2-2将移动客户端的需求映射到相关的微服务

我们需要决定移动端如何访问这些服务。我们来看看选择项。

### 客户端到微服务的直接访问

理论上来讲，一个客户端可以直接请求其中任何一个微服务。每一个微服务都有一个公开的端点：
https://serviceName.api.company.name

该URL将映射到微服务的负载均衡，将请求分发到可用的实例中。为了检索特定商品的页面信息，移动客户端将访问以上列出的每一个服务。


